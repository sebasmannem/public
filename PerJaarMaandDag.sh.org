#!/bin/sh

processFolder()
{
	SAVEIFS=$IFS
	IFS=$(echo "\n")
	FILES=$path/*
        for file in $FILES #`ls -Q -d $path/*`
        do
		base=`basename $file`
                if [ -d $file ]
                then
			if [ ${#base} -ne 4 -o `expr substr $base 1 2` != "20" ]
			then
				path=$file
        	                processFolder
                	        rmdir $path
				path=`dirname $path`
			fi
                elif [ -f $file ]
		then
                        Created=`exif -t 0x9003 $file 2>/dev/null | grep Value | cut -c10-100`
                        [ "$Created" = "" ] && Created=`stat -c %y $file`
                        Year=`echo "$Created" | cut -c1-4`
                        Month=`echo "$Created" | cut -c6-7`
                        Day=`echo "$Created" | cut -c09-10`

                        mkdir -p $root/$Year/$Month/$Day
                        mv "$file" "$root/$Year/$Month/$Day/"
                fi
        done
	IFS=$SAVEIFS
}


if [ -d $1 ]
then
	path=$1
	root=$1
	processFolder
fi
